#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# shellcheck source=lib/common.sh
source "$ROOT_DIR/lib/common.sh"
# shellcheck source=lib/rule_engine.sh
source "$ROOT_DIR/lib/rule_engine.sh"
# shellcheck source=lib/storage_engine.sh
source "$ROOT_DIR/lib/storage_engine.sh"
# shellcheck source=lib/migration_engine.sh
source "$ROOT_DIR/lib/migration_engine.sh"

usage() {
  cat <<'USAGE'
用法:
  coldhotctl init
  coldhotctl rule add <rule_id> <field> <op> <threshold> <target_tier>
  coldhotctl rule enable <rule_id>
  coldhotctl rule disable <rule_id>
  coldhotctl rule remove <rule_id>
  coldhotctl rule list

  coldhotctl storage set <tier> <policy_name> [description]
  coldhotctl storage list

  coldhotctl task create <task_id> <csv_file>
  coldhotctl task run <task_id>
  coldhotctl task list

  coldhotctl report show <task_id>
USAGE
}

cmd_init() {
  ensure_defaults
  if [[ ! -f "$ROOT_DIR/data/sample_data.csv" ]]; then
    cat > "$ROOT_DIR/data/sample_data.csv" <<'CSV'
id,age,access,size_mb,biz,current_tier
1,10,100,50,pay,hot
2,45,2,80,archive,hot
3,60,1,120,audit,hot
4,3,500,10,realtime,hot
5,90,0,300,legacy,hot
CSV
  fi
  echo "初始化完成"
}

main() {
  local cmd="${1:-}"
  case "$cmd" in
    init)
      cmd_init
      ;;
    rule)
      local sub="${2:-}"
      case "$sub" in
        add)
          [[ $# -eq 7 ]] || die "参数错误: rule add"
          rule_add "$3" "$4" "$5" "$6" "$7"
          ;;
        enable)
          [[ $# -eq 3 ]] || die "参数错误: rule enable"
          rule_enable "$3"
          ;;
        disable)
          [[ $# -eq 3 ]] || die "参数错误: rule disable"
          rule_disable "$3"
          ;;
        remove)
          [[ $# -eq 3 ]] || die "参数错误: rule remove"
          rule_remove "$3"
          ;;
        list)
          rule_list
          ;;
        *) usage; exit 1 ;;
      esac
      ;;
    storage)
      local sub="${2:-}"
      case "$sub" in
        set)
          [[ $# -ge 5 ]] || die "参数错误: storage set"
          storage_set "$3" "$4" "${5:-}"
          ;;
        list)
          storage_list
          ;;
        *) usage; exit 1 ;;
      esac
      ;;
    task)
      local sub="${2:-}"
      case "$sub" in
        create)
          [[ $# -eq 4 ]] || die "参数错误: task create"
          create_task "$3" "$4"
          ;;
        run)
          [[ $# -eq 3 ]] || die "参数错误: task run"
          run_task "$3"
          ;;
        list)
          list_tasks
          ;;
        *) usage; exit 1 ;;
      esac
      ;;
    report)
      local sub="${2:-}"
      case "$sub" in
        show)
          [[ $# -eq 3 ]] || die "参数错误: report show"
          show_report "$3"
          ;;
        *) usage; exit 1 ;;
      esac
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

main "$@"
